Perfect â€” switching to **Flutter + Cloudflare D1 backend** keeps the same idea but gives you full cross-platform power (Android + iOS + Web).
Below is a clean, **Flutter-focused PRD** with the D1 backend setup and how everything fits together technically.

---

# ðŸ“± Product Requirements Document (PRD)

**Project Name:** Shared Contact CRM (Flutter + Cloudflare D1 Edition)
**Platform:** Flutter (Android / iOS / Web optional)
**Backend:** Cloudflare Worker + Cloudflare D1 (SQLite-based Cloud DB)
**Version:** v3.0

---

## 1. Purpose

A simple, private CRM app for small teams.
Contacts and call logs are stored in Cloudflare D1 and synced across all devices.
Only an **admin** account exists initially; the admin creates users manually.
No public signup.

---

## 2. Goals & Objectives

* Centralized contact list shared by all users.
* Prevent duplicate phone numbers.
* Each user can edit only their own contacts.
* Admin can manage all contacts + users.
* JWT-based login/logout.
* Cross-platform Flutter client.

---

## 3. Authentication Model

### Users

* One predefined **admin** seeded in D1.
* Admin creates new users via `/admin/users`.
* Passwords hashed (bcrypt).

### Login Flow

1. User opens app â†’ if token absent/expired â†’ show **Login Screen**.
2. POST `/login` (email + password).
3. Worker returns JWT token (HS256).
4. Token stored in **SecureStorage**.
5. All API requests include `Authorization: Bearer <token>`.

### Logout

* Clears token from secure storage.
* Navigates back to login screen.

---

## 4. Core Features

### Contact Management

* Fields: `name`, `phone_number`, `created_by_user_id`.
* Unique phone number constraint.
* Users see all contacts but can modify only their own.
* Admin can modify all.

### Call Logging

* Detect incoming/outgoing calls (via `phone_state` or `call_log` plugin on Android).
* Save: `phone_number`, `direction`, `timestamp`, `duration`, `user_id`.
* Auto-link to contact if exists.

### Sync

* REST API communication with Worker.
* Local cache using **sqflite** or **Drift** for offline mode.
* Sync trigger on app resume or manual refresh.

---

## 5. Database Schema (Cloudflare D1)

```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  role TEXT CHECK(role IN ('admin','user')) DEFAULT 'user',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE contacts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  phone_number TEXT UNIQUE NOT NULL,
  created_by_user_id INTEGER,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME,
  FOREIGN KEY (created_by_user_id) REFERENCES users(id)
);

CREATE TABLE calls (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  contact_id INTEGER,
  user_id INTEGER,
  phone_number TEXT NOT NULL,
  direction TEXT CHECK(direction IN ('incoming','outgoing')),
  start_time DATETIME,
  duration INTEGER,
  FOREIGN KEY (contact_id) REFERENCES contacts(id),
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

---

## 6. API Endpoints (Cloudflare Worker)

| Method | Endpoint           | Description                       | Auth      |
| ------ | ------------------ | --------------------------------- | --------- |
| POST   | `/login`           | Validate credentials â†’ return JWT | Public    |
| GET    | `/contacts`        | List all contacts                 | JWT       |
| POST   | `/contacts`        | Add contact (unique check)        | JWT       |
| PUT    | `/contacts/:id`    | Update owned contact              | JWT       |
| DELETE | `/contacts/:id`    | Delete owned contact              | JWT       |
| GET    | `/calls`           | Get call logs                     | JWT       |
| POST   | `/calls`           | Add call log                      | JWT       |
| POST   | `/admin/users`     | Create new user                   | Admin JWT |
| DELETE | `/admin/users/:id` | Remove user                       | Admin JWT |

---

## 7. Flutter App Architecture

**Recommended Packages**

* `dio` â€“ HTTP client
* `flutter_secure_storage` â€“ JWT storage
* `provider` or `riverpod` â€“ state management
* `sqflite` / `drift` â€“ local cache
* `call_log`, `phone_state` â€“ call detection (Android)
* `intl` â€“ timestamps

### Folder Structure

```
lib/
 â”œâ”€ main.dart
 â”œâ”€ api/
 â”‚   â”œâ”€ api_client.dart
 â”‚   â””â”€ auth_interceptor.dart
 â”œâ”€ models/
 â”‚   â”œâ”€ contact.dart
 â”‚   â”œâ”€ call.dart
 â”‚   â””â”€ user.dart
 â”œâ”€ providers/
 â”‚   â”œâ”€ auth_provider.dart
 â”‚   â””â”€ contact_provider.dart
 â”œâ”€ screens/
 â”‚   â”œâ”€ login_screen.dart
 â”‚   â”œâ”€ contacts_screen.dart
 â”‚   â”œâ”€ call_logs_screen.dart
 â”‚   â””â”€ admin_screen.dart
 â”œâ”€ widgets/
 â”‚   â”œâ”€ contact_tile.dart
 â”‚   â””â”€ call_tile.dart
```

### Screen Flow

1. **Login Screen** â†’ email + password â†’ token saved.
2. **Contacts Screen** (default) â†’ list shared contacts.
3. **Add/Edit Contact** â†’ only owner can modify.
4. **Call Logs** tab â†’ synced logs.
5. **Admin Panel** (visible if role == admin) â†’ manage users.
6. **Logout Button** in header menu.

---

## 8. Security

* JWT tokens verified on each API call by Worker.
* Passwords hashed with bcrypt.
* Database enforces unique phone numbers.
* Role-based authorization inside Worker routes.

---

## 9. Deployment

* **Backend:** Cloudflare Worker with D1 binding.

  * `wrangler.toml` includes:

    ```toml
    [[d1_databases]]
    binding = "DB"
    database_name = "contacts_crm"
    database_id = "xxxxxxxxx"
    ```
* **Flutter App:**

  * Android & iOS builds via `flutter build apk / ipa`.
  * API base URL set via `.env` or constants file.

---

## 10. Future Enhancements

* Push notifications for shared contact updates.
* Web admin panel (using the same D1 API).
* Encrypted contact fields.
* Optional Google Drive or iCloud export.

---

âœ… **Result:**

* Fully private, lightweight CRM built with **Flutter + Cloudflare D1**.
* Admin-only user creation.
* Simple JWT login/logout.
* Shared contacts, call logs, no duplicates.
* Works on Android out of the box, extendable to iOS/web later.

---

Would you like me to now generate the **starter Flutter project code** (main .dart, login screen, contacts screen, and API client template) so you can run it against your Cloudflare Worker API?
